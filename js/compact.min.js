/*!
 * payONE v0.0.1 (http://payone.mindzgroup.com/)
 * Copyright 2017 Anant Anand Gupta
 */
!function(){"use strict";angular.module("mainApp",["ui.router","payment","common","kinvey","base64"])}(),function(){"use strict";let e=!1;angular.module("mainApp").config(["$locationProvider","$sceDelegateProvider",function(e,t){e.hashPrefix(""),e.html5Mode({enabled:!0,requireBase:!1}),t.resourceUrlWhitelist(["self","http://api.fixer.io/**"])}]).run(["$kinvey","$rootScope","$location","$q","$state","kinvey",function(t,n,r,o,c,u){n.$on("$stateChangeSuccess",function(e,t){"home"===t.name&&setTimeout(function(){$("#slTarget").selectpicker("render"),$("#slPurpose").selectpicker("render")},0),"payment"===t.name&&setTimeout(function(){$("#slCountries").selectpicker("render")},0)}),n.$on("$stateChangeStart",function(n,r,a){!1===e&&(n.preventDefault(),t.initialize(u.getApp()).then(function(){e=!0,t.ping().then(function(e){let n=t.User.getActiveUser(),u=o.resolve(n);null!==n?(u=n.me(),c.go(r.name,a)):t.User.login("payone","payone@123").then(function(e){c.go(r.name,a)}).catch(function(e){console.log(e)})}).catch(function(e){console.log("Can't connect to backend: "+e)})}).catch(function(e){console.log("kinvey init failed")}))})}])}(),function(){"use strict";angular.module("mainApp").config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/"),e.state("home",{url:"/",views:{"@":{templateUrl:"/home/index.html"},"home-header@home":{templateUrl:"/home/header.html",controller:"appHeaderController"},"home-methods@home":{templateUrl:"/home/methods.html"},"home-contact@home":{templateUrl:"/home/contact.html"},"home-footer@home":{templateUrl:"/home/footer.html"}}})}])}(),function(){"use strict";angular.module("mainApp").controller("appHeaderController",["$scope","kinvey","$state","lowercaseFilter",function(e,t,n,r){let o=function(){return r($("#slPurpose").find("option:selected").text())},c=function(){$("#slTarget").children().remove().attr("disabled","disabled").selectpicker({noneSelectedText:"Select Purpose First"}).selectpicker("refresh"),e.targets=[]},u=function(){c(),$("#slTarget").selectpicker({noneSelectedText:"Loading Options ..."}).selectpicker("refresh")},a=function(e,t){c(),e.forEach(function(e){$("#slTarget").append($("<option></option>").attr("value",e.key).text(e.text))},this),$("#slTarget").attr("disabled",null).selectpicker({noneSelectedText:t}).selectpicker("refresh")};e.purposeSelect=function(){let n="0";switch(n=e.purposes.length>0?e.purposes[0]:"0"){case"education":u(),o(),t.getTargets(n).then(function(e){a(e,"Select an Institute ...")});break;case"insurance":u(),o(),t.getTargets(n).then(function(e){a(e,"Select an Insurance Company ...")});break;default:c()}},e.continuePay=function(){n.go("payment",{purpose:o(),targetCode:e.targets[0]})}}])}(),function(){"use strict";angular.module("payment",["ui.router"])}(),function(){"use strict";angular.module("payment").config([function(){}]).run(["$rootScope",function(e){e.$on("$viewContentLoaded",function(e,t){switch(t){case"payment-heads@payment":setTimeout(function(){$("#slCountries").selectpicker("render")},0)}})}])}(),function(){"use strict";angular.module("payment").config(["$stateProvider",function(e){e.state("payment",{url:"/payment/:purpose/:targetCode",resolve:{target:["kinvey","$stateParams",function(e,t){return e.getPaymentDetail(t.targetCode).then(function(e){return e[0]})}],countryList:["countries",function(e){return e.getCountryList()}],targetCurrency:["target","countries",function(e,t){return t.getCurrencyByCountryCode(e.countryCode)}]},views:{"@":{templateUrl:"/payment/index.html",controller:"paymentIndexController"},"paymentTarget@payment":{templateUrl:"/payment/target.html"},"paymentHeads@payment":{templateUrl:"/payment/heads.html",controller:"paymentHeadsController"},"paymentUser@payment":{templateUrl:"/payment/user.html",controller:"paymentUserController"}}})}])}(),function(){"use strict";angular.module("payment").controller("paymentHeadsController",["$scope","$q","countryList","countries","currencyConverter","kinvey",function(e,t,n,r,o,c){let u=e.target.paymentHeads.map(e=>0),a=function(){$("#slCountries").children().remove().attr("disabled","disabled").selectpicker("refresh")},i=function(t){a(),e.countryList.forEach(function(e){$("#slCountries").append($("<option></option>").attr("value",e.code).text(e.name))},this),$("#slCountries").attr("disabled",null).selectpicker({noneSelectedText:t}).selectpicker("refresh")},s=function(){let e=0;return u.forEach(t=>{e+=t}),e};setTimeout(function(){i("Select Country")},0),e.$watch("paymentAmounts",function(){e.totalInTargetCurrency=s()},!0),e.countrySelect=function(){let n=null;e.canConvert=!1,e.countryCurrency=null,e.paymentMethods=null,e.processingConversion=!0,e.hasAlternateOptions=!1,e.countries.length>0?(n=e.countries[0],e.isCountrySelected=!0,r.getCurrencyByCountryCode(n).then(function(t){return e.countryCurrency=t,c.getCountryPaymentMethods(n)}).then(function(n){e.processingConversion=!0,n.length&&n[0].methods?e.countryPaymentMethods=n[0].methods:e.countryPaymentMethods=[{paymentMethodCode:"dom",isDefault:!0,isAlternate:!1}],e.countryPaymentMethods.forEach(t=>{!t.currencyCode&&(t.currencyCode=e.countryCurrency.code);t.selectionCode=t.paymentMethodCode+t.currencyCode}),e.paymentCurrencyCodes=[...new Set(e.countryPaymentMethods.filter(e=>e.currencyCode).map(e=>e.currencyCode))];let o=e.countryPaymentMethods.find(e=>e.isDefault);e.paymentMethod=o.paymentMethodCode+o.currencyCode;let c=[];return e.paymentCurrencies=[],e.paymentCurrencyCodes.forEach(t=>{c.push(r.getCurrencyByCode(t).then(function(t){e.paymentCurrencies.push(t)}))}),t.all(c)}).then(function(){return e.countryPaymentMethods.forEach(t=>{t.currency=e.paymentCurrencies.find(e=>e.code===t.currencyCode)}),o.convert(e.targetCurrency.code,e.paymentCurrencyCodes.join(","))}).then(function(t){return t.data&&e.countryPaymentMethods.forEach(n=>{n.rate=t.data.rates[n.currencyCode];(!n.rate&&e.countryCurrency.code===e.targetCurrency.code||n.currencyCode===e.targetCurrency.code)&&(n.rate=1)}),e.countryPaymentMethods=e.countryPaymentMethods.filter(e=>e.rate),e.hasAlternateOptions=!!e.countryPaymentMethods.find(e=>e.isAlternate),e.canConvert=e.countryPaymentMethods.length>0,c.getPaymentMethodDetail(e.countryPaymentMethods.map(e=>e.paymentMethodCode))}).then(function(t){console.log(t),e.countryPaymentMethods.forEach(e=>{e.title=t.find(t=>t.code===e.paymentMethodCode).title})}).catch(function(t){console.log(t),e.canConvert=!1,e.countryCurrency=null,e.paymentMethods=null,e.hasAlternateOptions=!1}).finally(function(){e.processingConversion=!1})):(n=null,e.isCountrySelected=!1)},e.continueStepOne=function(){},e.continueStepThree=function(){},e.getPaymentMethodDetail=function(e){return null.find(t=>t.code===e)},e.getCurrencyByCode=function(e){return r.getCurrencyByCode(e).then(function(e){return e})},e.toggleAlternate=function(){e.showAlternate=!e.showAlternate},e.countryList=n,e.paymentAmounts=u,e.isCountrySelected=!1,e.canConvert=!1,e.rateUSD=null,e.rate=null,e.countries=null,e.paymentMethods=null,e.paymentCurrency=null,e.countryCurrency=null,e.hasAlternateOptions=!1,e.showAlternate=!1}])}(),function(){"use strict";angular.module("payment").controller("paymentIndexController",["$scope","targetCurrency","target",function(e,t,n){e.target=n,!e.target.paymentHeads&&(e.target.paymentHeads=["Amount"]),e.targetCurrency=t}])}(),function(){"use strict";angular.module("payment").controller("paymentUserController",["$scope","$timeout","kinvey",function(e,t,n){let r={email:null,password:null};e.userLogin=function(){n.loginUser(e.user.email,e.user.password).then(function(t){console.log(t.data),e.loggedInUser=t.data,e.hasUser=!0}).catch(function(){delete e.loggedInUser,e.hasLoginError=!0,t(function(){e.hasLoginError=!1},1e4),e.hasUser=!1})},e.userLogout=function(){delete e.loggedInUser,e.hasUser=!1,e.user=angular.copy(r)},e.userRegister=function(){n.registerUser(e.user).then(function(t){console.log(t.data),e.loggedInUser=t.data,e.hasUser=!0}).catch(function(){delete e.loggedInUser,e.hasRegisterError=!0,t(function(){e.hasRegisterError=!1},1e4),e.hasUser=!1})},e.continueStepTwo=function(){alert("Account / Card Details will be entered in next step")},e.user=angular.copy(r),e.hasUser=!1,e.panelType="reg",e.hasLoginError=!1,e.hasRegisterError=!1}])}(),function(){"use strict";angular.module("common",[])}(),function(){"use strict";angular.module("common").config([function(){}])}(),function(){"use strict";angular.module("common").filter("capitalize",function(e=!1){return function(t){return t?t.split(" ").map(function(t){return t.charAt(0).toUpperCase()+(e?t.substr(1).toLowerCase():t.substr(1))}).join(" "):""}})}(),function(){"use strict";angular.module("common").provider("countries",function(){let e=null,t=null,n=null;this.$get=["$http","$q",function(r,o){let c={},u=function(){return r({url:"https://restcountries.eu/rest/v2/all?fields=name;alpha3Code;currencies;timezones",method:"GET"}).then(function(r){return e=r.data,t=e.map(function(e){return{name:e.name,code:e.alpha3Code,currency:e.currencies[0]}}),n=[...new Set(e.map(e=>e.currencies[0]))],o.resolve(e)})};return c.getCountryList=function(){return e?o.resolve(t):u().then(function(){return o.resolve(t)})},c.getCurrencyByCountryCode=function(n){if(e){let e=t.find(function(e){return e.code===n});return o.resolve(e.currency)}return u().then(function(){let e=t.find(function(e){return e.code===n});return o.resolve(e.currency)})},c.getCurrencyByCode=function(t){if(e){let e=n.find(function(e){return e.code===t});return o.resolve(e)}return u().then(function(){let e=n.find(function(e){return e.code===t});return o.resolve(e)})},c}]})}(),function(){"use strict";angular.module("common").provider("currencyConverter",function(){this.$get=["$http",function(e){let t={};return t.convert=function(t,n){return e({url:"http://api.fixer.io/latest",params:{base:t,symbols:n},method:"JSONP"})},t}]})}(),function(){"use strict";angular.module("common").provider("kinvey",function(){let e={},t={appKey:"kid_HkkPNq3--",appSecret:"519be0bec2d74958a80e514537d1e675"};this.$get=["$http","$q","$kinvey","$base64",function(n,r,o,c){let u={};return u.getApp=function(){return t},u.getTargets=function(t){if(e[t])return r.resolve(e[t]);{let n=o.DataStore.collection(t,o.DataStoreType.Network),c=r.defer();return n.find().subscribe(function(n){e[t]=n},function(e){},function(){c.resolve(e[t])}),c.promise}},u.getCountryPaymentMethods=function(e){let t=r.defer(),n=new o.Query;n.equalTo("code",e);let c=null;return o.DataStore.collection("countryPaymentMethod",o.DataStoreType.Network).find(n).subscribe(function(e){c=e},function(e){t.reject(e)},function(){t.resolve(c)}),t.promise},u.getPaymentMethodDetail=function(e){let t=r.defer(),n=new o.Query;n.equalTo("code",e[0]);for(let t=1;t<e.length;t++){let r=new o.Query;r.equalTo("code",e[t]),n=n.or(r)}let c=null;return o.DataStore.collection("paymentMethod",o.DataStoreType.Network).find(n).subscribe(function(e){c=e},function(e){t.reject(e)},function(){c.length?t.resolve(c):t.reject()}),t.promise},u.loginUser=function(e,r){let o={url:"https://baas.kinvey.com/user/kid_HkkPNq3--/login",method:"POST",data:{username:e,password:r},headers:{authorization:"Basic "+c.encode(t.appKey+":"+t.appSecret),"cache-control":"no-cache"}};return n(o)},u.registerUser=function(e){e.username=e.email;let r={url:"https://baas.kinvey.com/user/kid_HkkPNq3--",method:"POST",data:e,headers:{authorization:"Basic "+c.encode(t.appKey+":"+t.appSecret),"cache-control":"no-cache"}};return n(r)},u.getPaymentDetail=function(e){let t=r.defer(),n=new o.Query;n.equalTo("code",e);let c=null;return o.DataStore.collection("payment",o.DataStoreType.Network).find(n).subscribe(function(e){c=e},function(e){t.reject(e)},function(){c.length?t.resolve(c):t.reject()}),t.promise},u}]})}();